<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Donation Platform</title>
    <!--<link rel="stylesheet" href="common.css">-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap" rel="stylesheet">
    
    <style>
        * {
            box-sizing: border-box;
        }
    
        body {
            font-family: "Nunito", sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f0f0f0;
            color: #121212;
            margin: 0;
        }

        /* Dark Mode */
        body.dark-mode {
            background-color: #121212;
            color: #E0E0E0;
        }

        /* Light Mode (default) */
        body.light-mode {
            background-color: white;
            color: black;
        }            
    
        #annotation-container {
            display: flex;
            width: 97%;
            height: 93vh;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }
    
        #user-list {
            width: 25%;
            border-right: 1px solid #ddd;
            padding: 20px;
            background-color: #f7f7f7;
        }
    
        #contacts {
            list-style: none;
            padding: 0;
            margin-top: 10px;
        }
    
        #contacts li {
            padding: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            border-radius: 5px;
            border: 1px solid #ddd;
            margin-bottom: 5px;
        }
        #contacts input[type="radio"] {
        margin-left: 5px; /* Adds extra space between the text and the radio button */
        margin-right: 50px;
        }
    
        #chat-box {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
    
        #chat-header {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            background-color: #f1f1f1;
        }
    
        #messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #f9f9f9;
        }
    
        .message {
            margin-bottom: 10px;
            display: flex;
        }
    
        .message.self .content {
            background-color: #d5c6f8;
            margin-left: auto;
        }
    
        .message.other .content {
            background-color: #a8a8a8;
            border: 1px solid #ddd;
        }
    
        .content {
            padding: 10px;
            border-radius: 5px;
            max-width: 60%;
        }
    
        #annotation-options {
            padding: 20px;
            border-top: 1px solid #ddd;
            background-color: #f1f1f1;
        }
    
        #annotation-options div {
            margin-bottom: 10px;
        }
    
        textarea {
            width: 100%;
            resize: none;
        }
    
        </style>
</head>
<body><!--
    <header>
        <nav>
            <ul>
                <div class="left-nav">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="instruction.html">Instruction</a></li>
                    <li><a href="about.html">About</a></li>
                    <li><a href="login.html">Login</a></li>
                    <li><a href="resources.html">Resources</a></li>
                </div>
                <div class="right-nav">                   
                        <li><button onclick="enableDarkMode()">
                            <i class="fas fa-moon fa-fade" style="color: #0b0047"></i>
                        </button></li>
                        <li><button onclick="enableLightMode()">
                            <i class="fas fa-sun fa-flip" style="color:rgb(216, 216, 3)"></i>
                        </button></li>
                </div>
            </ul>
        </nav>
    </header>-->

    <!-- Main Content 
    <main>-->
        <div id="annotation-container">
            <!-- Sidebar for contacts -->
            <div id="user-list">
                <h2>Contacts</h2>
                <ul id="contacts">
                    <!-- Contacts loaded from JSON data will go here -->
                </ul>
            </div>
    
            <!-- Chat display and annotation options -->
            <div id="chat-box">
                <div id="chat-header">
                    <h2 id="chat-with">&nbsp;&nbsp; Conversation</h2>
                </div>
                <div id="messages"></div>
    
                <!-- Annotation options for messages -->
                <div id="annotation-options">
                    <button id="save-annotation" style="display: inline-block; padding: 8px 10px; background-color: #696969; color: white; text-decoration: none; font-size: 17px;">
                        Save Annotation</button>&nbsp;&nbsp;&nbsp;&nbsp;
                    <a href="2annotation.html" style="display: inline-block; padding: 8px 10px; background-color: #696969; color: white; text-decoration: none; font-size: 17px;">
                        Next</a>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        <button onclick="enableDarkMode()" style="background-color: transparent; border: none; font-size: 20px;">
                            <i class="fas fa-moon fa-fade" style="color: #0b0047"></i>
                        </button>  
                        <button onclick="enableLightMode()" style="background-color: transparent; border: none; font-size: 20px;">
                            <i class="fas fa-sun fa-fade" style="color:rgb(216, 216, 3)"></i>
                        </button> 
                </div>
            </div>
        </div>
    
    <!--
    </main>
    <footer>
        <p style="color:#383838">&copy; 2024 Data Donation Platform. All rights reserved.</p>
    </footer>-->

    <script>
        if (!checkUserLoggedIn(true)) return;
        //Checks if user is logged in
        const username = checkSession();
        if (!username) return; // Stop if session is invalid

        document.querySelector('a[href="annotation.html"]').addEventListener('click', (e) => {
            if (!checkUserLoggedIn(true)) e.preventDefault(); // Redirect if not logged in
        });

    </script>

    <script>
            document.addEventListener("DOMContentLoaded", () => {
            // Hardcoded sample data for users and messages
            const sampleData = {
                users: [
                    { id: 1, name: "Alice" },
                    { id: 2, name: "Bob" },
                    { id: 3, name: "Charlie" }
                ],
                messages: [
                    { sender: "self", recipient: "Alice", text: "Hi Alice! How are you?" },
                    { sender: "Alice", recipient: "self", text: "I'm good, thanks! How about you?" },
                    { sender: "self", recipient: "Alice", text: "I'm doing well! Just working on a project." },
                    { sender: "Alice", recipient: "self", text: "That’s great! Let me know if you need help." },
                    { sender: "Bob", recipient: "self", text: "Hey! Have you seen the new movie yet?" },
                    { sender: "self", recipient: "Bob", text: "Not yet, planning to this weekend!" },
                    { sender: "Charlie", recipient: "self", text: "Can you send me the project files?" },
                    { sender: "Alice", recipient: "self", text: "I'm good, thanks! How about you?" },
                    { sender: "Alice", recipient: "self", text: "That’s great! Let me know if you need help." },
                    { sender: "self", recipient: "Charlie", text: "Yes sure." }
                ]
            };

            // Display contacts and add click event to load chat
            displayContacts(sampleData.users);

            // Display contacts in the sidebar
            function displayContacts(users) {

                if (!checkUserLoggedIn(true)) return; // Redirect if not logged in
                const username = checkSession();
                if (!username) return; // Stop if session is invalid

                const contacts = document.getElementById("contacts");
                contacts.innerHTML = "";
                users.forEach(user => {
                    const li = document.createElement("li");
                    li.textContent = user.name;
                    li.classList.add("contact");

                    // Safety annotation for each user
                    const safeOption = document.createElement("input");
                    safeOption.type = "radio";
                    safeOption.name = `user-${user.id}-safety`;
                    safeOption.value = "safe";
                    const unsafeOption = document.createElement("input");
                    unsafeOption.type = "radio";
                    unsafeOption.name = `user-${user.id}-safety`;
                    unsafeOption.value = "unsafe";
                    
                    li.append(" Safe", safeOption, "Unsafe", unsafeOption);

                    // Add click event to load messages for the selected contact
                    li.addEventListener("click", () => {
                        document.getElementById("chat-with").textContent = `Chat with ${user.name}`;
                        displayMessages(sampleData.messages, user.name);
                    });

                    contacts.appendChild(li);
                });
            }

            // Display messages for the selected contact
            function displayMessages(messages, contactName) {

                if (!checkUserLoggedIn(true)) return; // Redirect if not logged in
                const username = checkSession();
                if (!username) return; // Stop if session is invalid

                const messagesContainer = document.getElementById("messages");
                messagesContainer.innerHTML = "";

                // Filter messages between "self" and the selected contact
                const filteredMessages = messages.filter(msg =>
                    (msg.sender === "self" && msg.recipient === contactName) ||
                    (msg.sender === contactName && msg.recipient === "self")
                );

                filteredMessages.forEach(msg => {
                    const messageElem = document.createElement("div");
                    messageElem.classList.add("message", msg.sender === "self" ? "self" : "other");

                    const contentElem = document.createElement("div");
                    contentElem.classList.add("content");
                    contentElem.textContent = msg.text;

                    messageElem.appendChild(contentElem);
                    messagesContainer.appendChild(messageElem);

                    // Add click event to annotate message
                    messageElem.addEventListener("click", () => {
                        selectMessageForAnnotation(msg);
                    });
                });
            }

            function selectMessageForAnnotation(message) {
                // Reset annotation form fields
                document.querySelector('input[name="message-safety"]').checked = false;
                document.getElementById("risk-type").value = "";
                document.getElementById("severity").value = 5;
                document.getElementById("extra-context").value = "";
            }

            // Save annotation
            document.getElementById("save-annotation").addEventListener("click", () => {
                const safety = document.querySelector('input[name="message-safety"]:checked')?.value;
                const riskType = document.getElementById("risk-type").value;
                const severity = document.getElementById("severity").value;
                const extraContext = document.getElementById("extra-context").value;

                const annotation = {
                    safety,
                    riskType,
                    severity,
                    extraContext,
                };

                console.log("Saved annotation:", annotation);
                // Send the annotation to the backend (not implemented here)
            });
        });
        </script>


    <script>
        function darkMode() {
            let element = document.body;
            let content = document.getElementById("DarkModetext");
            element.className = "dark-mode";
            content.innerText = "Dark Mode is ON";
        }
        function lightMode() {
            let element = document.body;
            let content = document.getElementById("DarkModetext");
            element.className = "light-mode";
            content.innerText = "Dark Mode is OFF";
        }
    </script>
    
    

    <script>
        const API_URL = 'http://3.12.198.71:5000'; // Replace with your EC2 public IP

        // Function to fetch annotating participants
        async function fetchAnnotatingParticipants() {
            const username = sessionStorage.getItem('username');
            if (!username) {
                alert('Please log in first!');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/annotatingparticipants`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                });

                const data = await response.json();
                if (response.ok) {
                    // Populate contacts list
                    const contactsList = document.getElementById('contacts');
                    contactsList.innerHTML = ''; // Clear previous list
                    data.titles.forEach(title => {
                        const li = document.createElement('li');
                        li.innerText = title;
                        contactsList.appendChild(li);
                    });
                } else {
                    alert(data.message || 'No participants ready for annotation.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while fetching participants.');
            }
        }

        // Function to fetch messages for a specific participant
        async function fetchMessagesForParticipant(participantTitle) {
            const username = sessionStorage.getItem('username');
            if (!username) {
                alert('Please log in first!');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/annotatingparticipants/messages?title=${participantTitle}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                });

                const data = await response.json();
                if (response.ok) {
                    const messagesContainer = document.getElementById('messages');
                    messagesContainer.innerHTML = ''; // Clear previous messages

                    data.messages.forEach(message => {
                        const messageDiv = document.createElement('div');
                        messageDiv.classList.add('message');
                        messageDiv.style.textAlign = message.alignment;

                        const sender = document.createElement('strong');
                        sender.innerText = message.sender;
                        messageDiv.appendChild(sender);

                        const content = document.createElement('p');
                        content.innerText = message.content;
                        messageDiv.appendChild(content);

                        const timestamp = document.createElement('small');
                        timestamp.innerText = message.timestamp;
                        messageDiv.appendChild(timestamp);

                        messagesContainer.appendChild(messageDiv);
                    });
                } else {
                    alert(data.error || 'No messages found.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while fetching messages.');
            }
        }

        // Function to annotate a participant (safe/unsafe)
        async function annotateParticipant(participantTitle, annotation) {
            const username = sessionStorage.getItem('username');
            if (!username) {
                alert('Please log in first!');
                return;
            }

            if (annotation !== 'safe' && annotation !== 'unsafe') {
                alert('Invalid annotation. Please select either "safe" or "unsafe".');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/annotatingparticipants/annotate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: participantTitle,
                        annotation: annotation,
                    }),
                });

                const data = await response.json();
                if (response.ok) {
                    alert('Annotation saved successfully.');
                } else {
                    alert(data.error || 'Failed to save annotation.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while saving the annotation.');
            }
        }

        // Event listener for the "Save Annotation" button
        document.getElementById('save-annotation').addEventListener('click', async () => {
            const participantTitle = document.getElementById('chat-with').innerText.trim();
            const annotation = prompt('Enter annotation (safe/unsafe):');

            if (annotation) {
                await annotateParticipant(participantTitle, annotation);
            }
        });

        // Fetch participants when the page loads
        window.addEventListener('DOMContentLoaded', () => {
            fetchAnnotatingParticipants();
        });

    </script>
    <!--<script src="script.js"></script>-->
</body>
</html>